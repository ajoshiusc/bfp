#LyX 2.2 created this file. For more info see http://www.lyx.org/
\lyxformat 508
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass amsart
\use_default_options true
\begin_modules
theorems-ams
eqs-within-sections
figs-within-sections
\end_modules
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "lmodern" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize letterpaper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Demons registration based on fMRI
\end_layout

\begin_layout Standard
In demons model, template and subject images are modelled by optical flow
 of one object, observed at two time points.
\end_layout

\begin_layout Standard
We start with BrainSync transformed fmri data across two subjects.
 Both of these are represented on the square map defined by SVReg.
 Following derivation in 
\begin_inset CommandInset citation
LatexCommand cite
key "cachier:inria-00072962"

\end_inset

, demons paper:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
F(p(t),s)=const.
\]

\end_inset


\end_layout

\begin_layout Standard
Let 
\begin_inset Formula $F(p,s)$
\end_inset

 denote fmri data at 
\begin_inset Formula $s^{th}$
\end_inset

 fmri-time point, at spatial point 
\begin_inset Formula $p$
\end_inset

 in the square.
\end_layout

\begin_layout Standard
If we differentiate eq (2) wrt 
\begin_inset Formula $t$
\end_inset

, we get:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\nabla_{p}F(p(t),s)\cdot\frac{dp(t)}{dt}+\frac{dF}{dt}(p(t),s)=\nabla F(p(t),s)^{T}\cdot v+\frac{dF(p(t),s)}{dt}=0
\]

\end_inset

 where 
\begin_inset Formula $v$
\end_inset

 is the velocity of point 
\begin_inset Formula $p$
\end_inset

 at time 
\begin_inset Formula $t$
\end_inset

.
 Therefore, we want to minimize over 
\begin_inset Formula $v$
\end_inset

,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
C(v)=\int\left\Vert \nabla F(p(t),s)\cdot v+\frac{dF(p(t),s)}{dt}\right\Vert ^{2}ds
\]

\end_inset

 Taking derivative of both sides wrt 
\begin_inset Formula $v$
\end_inset

, and equate to zero, we get
\begin_inset Formula 
\[
2\int\nabla F(p(t),s)\cdot(\nabla F(p(t),s)\cdot v+\frac{dF(p(t),s)}{dt})ds=0
\]

\end_inset

 Therefore,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v\cdot\int\left\Vert \nabla F(p(t),s)\right\Vert ^{2}ds & =-\int\frac{dF(p(t),s)}{dt}\cdot\nabla F(p(t),s)ds
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
we get,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v= & -\frac{\int\frac{dF(p(t),s)}{dt}\cdot\nabla F(p(t),s)ds}{\int\left\Vert \nabla F(p(t),s)\right\Vert ^{2}ds},
\end{align*}

\end_inset


\end_layout

\begin_layout Standard
Adding the demons forces for stability,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align*}
v= & -\frac{\int\frac{dF(p(t),s)}{dt}\cdot\nabla F(p(t),s)ds}{\int\left\Vert \nabla F(p(t),s)\right\Vert ^{2}ds+\alpha^{2}\int||\frac{dF(p(t),s)}{dt}||^{2}ds},
\end{align*}

\end_inset

and the corresponding discrete version without the demons forces is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v=-\frac{\sum_{n=1}^{N}\frac{dF^{n}(p)}{dt}\cdot\nabla F^{n}(p(t))}{\sum_{n=1}^{N}||\nabla F^{n}(p)||^{2}}
\]

\end_inset

, and with demons forced:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
v=-\frac{\sum_{n=1}^{N}\frac{dF^{n}(p)}{dt}\cdot\nabla F^{n}(p(t))}{\sum_{n=1}^{N}||\nabla F^{n}(p)||^{2}+\alpha^{2}\sum_{n=1}^{N}||\frac{dF^{n}(p(t))}{dt}||^{2}}
\]

\end_inset

where 
\begin_inset Formula $n$
\end_inset

 indicates fmri-time point.
 
\end_layout

\begin_layout Standard
\begin_inset Formula $F_{T}$
\end_inset

 indicate the target image and 
\begin_inset Formula $F_{M}$
\end_inset

 is the moving image, 
\begin_inset Formula $T(p)$
\end_inset

 is the deformation at the current iteration.
 We get
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
u(p)=\frac{\sum_{n=1}^{N}(F_{T}^{n}(p)-F_{M}^{n}\circ T(p))\cdot\nabla F_{T}^{n}(p)}{\sum_{n=1}^{N}||\nabla F_{T}^{n}(p)||^{2}+\alpha^{2}\sum_{n=1}^{N}(F_{T}^{n}(p)-F_{M}^{n}\circ T(p))^{2}}
\]

\end_inset


\end_layout

\begin_layout Standard
This is similar equation to eq 4 in 
\begin_inset CommandInset citation
LatexCommand cite
key "cachier:inria-00072962"

\end_inset

, but with summations in the numerator and denominator.
\end_layout

\begin_layout Standard
But
\end_layout

\begin_layout Standard
\begin_inset Formula $0\leq\sum_{n=1}^{N}(\alpha(F_{T}^{n}-F_{M}^{n}\circ T)-||\nabla F_{T}^{n}||)^{2}=\alpha^{2}\sum_{n=1}^{N}(F_{T}^{n}-F_{M}^{n}\circ T)^{2}+\sum_{n=1}^{N}||\nabla F_{T}^{n}||^{2}-2\alpha\sum_{n=1}^{N}|F_{T}^{n}-F_{M}^{n}\circ T|\cdot||\nabla F_{T}^{n}||$
\end_inset


\end_layout

\begin_layout Standard
So the displacement given by the above equation is bounded by 
\begin_inset Formula $1/2\alpha$
\end_inset

.
\end_layout

\begin_layout Standard
The proposed algorithm is given in Algorithm 
\begin_inset CommandInset ref
LatexCommand ref
reference "alg:fMRI-Demons-with"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float algorithm
wide false
sideways false
status collapsed

\begin_layout Enumerate
Initialize with square maps and 0 displacement.
 
\end_layout

\begin_layout Enumerate
fMRI data for 2 subjects mapped to the squares 
\end_layout

\begin_layout Enumerate
Find 
\begin_inset Formula $v(p)$
\end_inset

 and update 
\begin_inset Formula $T(p)\rightarrow T(p)+v(p)$
\end_inset

, 
\end_layout

\begin_layout Enumerate
warp the fMRI data using this displacement.
 
\end_layout

\begin_layout Enumerate
Apply BrainSync 
\end_layout

\begin_layout Enumerate
Check if error reduced, if not go to step 2.
 
\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
fMRI Demons with BrainSync
\begin_inset CommandInset label
LatexCommand label
name "alg:fMRI-Demons-with"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Remark
If we want to incorporate surface metric 
\begin_inset Formula $G(p)$
\end_inset

, we replace the dot product 
\begin_inset Formula $f_{1}(p)\cdot f_{2}(p)$
\end_inset

 with 
\begin_inset Formula $(f_{1}^{T}(p)G(p)f_{2}(p))$
\end_inset

 everywhere, where 
\begin_inset Formula $G(p)$
\end_inset

 is 2x2 surface metric.
\end_layout

\begin_layout Remark
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "aaj_bib"
options "elsarticle-harv"

\end_inset


\end_layout

\end_body
\end_document
